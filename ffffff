import re, requests, json
from urllib.parse import urljoin

HEADERS_BASE = {
    "User-Agent": (
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) "
        "AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36"
    ),
}
TIMEOUT = 12

def unpack_packer_simple(js):
    """ÙŠÙÙƒ eval-packer Ù…Ù† Ù†ÙˆØ¹ eval(function(p,a,c,k,e,d)...)"""
    m = re.search(
        r"eval\(function\(p,a,c,k,e,d\)\{.*?\}\(\s*['\"](.*?)['\"]\s*,\s*(\d+)\s*,\s*\d+\s*,\s*['\"](.*?)['\"]",
        js, re.S)
    if not m:
        return None
    payload, radix, sympipe = m.groups()
    radix = int(radix)
    symtab = sympipe.split("|")
    token_re = re.compile(r"\b[0-9a-zA-Z]+\b")
    def repl(mo):
        tok = mo.group(0)
        try:
            idx = int(tok, radix)
            return symtab[idx] if 0 <= idx < len(symtab) else tok
        except:
            return tok
    return token_re.sub(repl, payload)

def extract_hls4_link(page_url):
    # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù€ Headers Ù…Ø¹ Referer Ø®Ø§Øµ Ù„Ù€ EarnVids
    headers = HEADERS_BASE.copy()
    if "fdewsdc.sbs" in page_url:
        headers["Referer"] = "https://shhahid4u.cam"
        print("ğŸŒ ØªÙ… ØªØ¹ÙŠÙŠÙ† Referer: https://shhahid4u.cam")

    # Ø¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø©
    r = requests.get(page_url, headers=headers, timeout=TIMEOUT)
    if r.status_code != 200:
        print("âŒ HTTP", r.status_code)
        return None

    if "eval(function" not in r.text:
        print("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ eval ÙÙŠ Ø§Ù„ØµÙØ­Ø©.")
        return None

    unpacked = unpack_packer_simple(r.text)
    if not unpacked:
        print("âŒ ÙØ´Ù„ ÙÙƒÙ‘ packer.")
        return None

    # Ù†Ø¨Ø­Ø« Ø¹Ù† var links = {...}
    m = re.search(r"var\s+links\s*=\s*(\{.*?\});", unpacked, re.S)
    if not m:
        print("âŒ Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ ÙƒØ§Ø¦Ù† links.")
        return None

    js_obj = m.group(1).replace("'", '"')
    try:
        links = json.loads(js_obj)
    except Exception:
        links = dict(re.findall(r'"([^"]+)"\s*:\s*"([^"]+)"', js_obj))

    link = links.get("hls4") or links.get("hls") or ""
    if link.startswith("/"):
        link = urljoin(page_url, link)
    return link

# ====== Ø£Ù…Ø«Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ======
servers = [
    "https://fdewsdc.sbs/embed/kvgpm2zeky40",  # EarnVids (Ù…Ø¹ Referer)
    "https://fsdcmo.sbs/e/gxvdnc0xtj19"        # StreamHG
]
for s in servers:
    print("\nğŸ”¹", s)
    url = extract_hls4_link(s)
    print("âœ…", url if url else "ÙØ´Ù„")

package com.example

import com.lagradost.cloudstream3.*
import com.lagradost.cloudstream3.utils.*
import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

class ShabakatyCinemanaProvider : MainAPI() {
    override var name = "Shabakaty Cinemana"
    override var mainUrl = "https://cinemana.shabakaty.com"
    override var lang = "ar"
    override val hasMainPage = true
    override val supportedTypes = setOf(TvType.Movie, TvType.TvSeries)

    private val api = "$mainUrl/api/android"

    override suspend fun getMainPage(page: Int, request: MainPageRequest): HomePageResponse {
        val items = mutableListOf<HomePageList>()

        val moviesUrl = "$api/latestMovies/level/0/itemsPerPage/24/page/$page/"
        val seriesUrl = "$api/latestSeries/level/0/itemsPerPage/24/page/$page/"

        val movies = app.get(moviesUrl).parsedSafe<List<CinemanaItem>>() ?: emptyList()
        val series = app.get(seriesUrl).parsedSafe<List<CinemanaItem>>() ?: emptyList()

        items += HomePageList("أحدث الأفلام", movies.map { it.toSearchResponse() })
        items += HomePageList("أحدث المسلسلات", series.map { it.toSearchResponse() })

        return HomePageResponse(items)
    }

    override suspend fun search(query: String): List<SearchResponse> {
        val moviesUrl = "$api/AdvancedSearch?level=0&type=Movies&videoTitle=$query"
        val seriesUrl = "$api/AdvancedSearch?level=0&type=Series&videoTitle=$query"

        val movies = app.get(moviesUrl).parsedSafe<List<CinemanaItem>>()?.map { it.toSearchResponse() } ?: emptyList()
        val series = app.get(seriesUrl).parsedSafe<List<CinemanaItem>>()?.map { it.toSearchResponse() } ?: emptyList()

        return movies + series
    }

    override suspend fun load(url: String): LoadResponse? {
        val videoId = url // نمرّر nb كـ data/url
        val detailsUrl = "$api/allVideoInfo/id/$videoId"
        val details = app.get(detailsUrl).parsedSafe<CinemanaItem>() ?: return null

        val title = details.enTitle ?: return null
        val poster = details.imgObjUrl
        val year = details.year?.toIntOrNull()
        val plot = details.enContent
        val score = details.stars?.toDoubleOrNull()?.let { Score.from10(it) } // بديل rating القديم

        return if (details.videoType == 2) {
            // مسلسل
            val epsUrl = "$api/videoSeason/id/$videoId"
            val eps = app.get(epsUrl).parsedSafe<List<CinemanaEpisode>>() ?: emptyList()

            val episodes = eps.map { e ->
                newEpisode(e.nb ?: videoId) {
                    name = "الموسم ${e.season} - الحلقة ${e.episodeNummer}"
                    season = e.season?.toIntOrNull()
                    episode = e.episodeNummer?.toIntOrNull()
                }
            }.sortedWith(compareBy({ it.season }, { it.episode }))

            newTvSeriesLoadResponse(title, url, TvType.TvSeries, episodes) {
                posterUrl = poster
                this.year = year
                this.plot = plot
                this.score = score
            }
        } else {
            // فيلم
            newMovieLoadResponse(title, url, TvType.Movie, data = videoId) {
                posterUrl = poster
                this.year = year
                this.plot = plot
                this.score = score
            }
        }
    }

    override suspend fun loadLinks(
        data: String,
        isCasting: Boolean,
        subtitleCallback: (SubtitleFile) -> Unit,
        callback: (ExtractorLink) -> Unit
    ): Boolean {
        val videoId = data

        // الروابط
        val videosUrl = "$api/transcoddedFiles/id/$videoId"
        val vids = app.get(videosUrl).parsedSafe<List<CinemanaVideo>>().orEmpty()

        vids.forEach { v ->
            val link = v.videoUrl ?: return@forEach
            val quality = v.resolution?.filter { it.isDigit() }?.toIntOrNull()
            callback(
                newExtractorLink(
                    source = name,
                    name = v.resolution ?: name,
                    url = link,
                    referer = "$mainUrl/",
                    quality = quality,
                    isM3u8 = link.endsWith(".m3u8", true)
                )
            )
        }

        // الترجمات
        val subsUrl = "$api/translationFiles/id/$videoId"
        val subs = app.get(subsUrl).parsedSafe<CinemanaSubtitleHolder>()?.translations.orEmpty()
        subs.forEach { s ->
            val lang = s.name ?: "Unknown"
            val file = s.file ?: return@forEach
            subtitleCallback(SubtitleFile(lang, file))
        }

        return true
    }

    // ================== Models ==================

    @Serializable
    data class CinemanaItem(
        val nb: String? = null,
        @SerialName("en_title") val enTitle: String? = null,
        val imgObjUrl: String? = null,
        val year: String? = null,
        @SerialName("en_content") val enContent: String? = null,
        val stars: String? = null,
        val videoType: Int? = null // 1 = فيلم, 2 = مسلسل (تخمين حسب كودك)
    ) {
        fun toSearchResponse(): SearchResponse {
            val id = nb ?: "0"
            return if (videoType == 2) {
                newTvSeriesSearchResponse(enTitle ?: "No Title", id) {
                    posterUrl = imgObjUrl
                    year = this@CinemanaItem.year?.toIntOrNull()
                }
            } else {
                newMovieSearchResponse(enTitle ?: "No Title", id) {
                    posterUrl = imgObjUrl
                    year = this@CinemanaItem.year?.toIntOrNull()
                }
            }
        }
    }

    @Serializable
    data class CinemanaEpisode(
        val nb: String? = null,
        val episodeNummer: String? = null,
        val season: String? = null
    )

    @Serializable
    data class CinemanaVideo(
        val videoUrl: String? = null,
        val resolution: String? = null
    )

    @Serializable
    data class CinemanaSubtitleHolder(
        val translations: List<CinemanaSubtitleFile> = emptyList()
    )

    @Serializable
    data class CinemanaSubtitleFile(
        val file: String? = null,
        val name: String? = null
    )
}        val moviesUrl = "$mainUrl/api/android/AdvancedSearch?level=0&type=Movies&videoTitle=$query"
        val movies = app.get(moviesUrl).parsedSafe<List<CinemanaItem>>()?.map { it.toSearchResponse() } ?: emptyList()

        val seriesUrl = "$mainUrl/api/android/AdvancedSearch?level=0&type=Series&videoTitle=$query"
        val series = app.get(seriesUrl).parsedSafe<List<CinemanaItem>>()?.map { it.toSearchResponse() } ?: emptyList()

        return movies + series
    }

    override suspend fun load(url: String): LoadResponse? {
        val videoId = url
        val detailsUrl = "$mainUrl/api/android/allVideoInfo/id/$videoId"
        val details = app.get(detailsUrl).parsed<CinemanaItem>()

        val title = details.enTitle ?: return null
        val posterUrl = details.imgObjUrl
        val year = details.year?.toIntOrNull()
        val plot = details.enContent
        val scoreInt = details.stars?.let { (it.toFloat() / 2 * 10).toInt() }
        val recommendations = mutableListOf<SearchResponse>()

        if (details.videoType == 2) {
            val episodesUrl = "$mainUrl/api/android/videoSeason/id/$videoId"
            val episodes = app.get(episodesUrl).parsedSafe<List<CinemanaEpisode>>()?.map {
                newEpisode(it) {
                    this.name = "الموسم ${it.season} - الحلقة ${it.episodeNummer}"
                    this.episode = it.episodeNummer?.toIntOrNull()
                    this.season = it.season?.toIntOrNull()
                    this.data = it.nb
                }
            }?.sortedWith(compareBy({ it.season }, { it.episode })) ?: emptyList()

            return newTvSeriesLoadResponse(title, url, TvType.TvSeries, episodes) {
                this.posterUrl = posterUrl
                this.year = year
                this.plot = plot
                this.rating = scoreInt
                this.recommendations = recommendations
                this.contentRating = null
            }
        } else {
            return newMovieLoadResponse(title, url, TvType.Movie, url) {
                this.posterUrl = posterUrl
                this.year = year
                this.plot = plot
                this.rating = scoreInt
                this.recommendations = recommendations
                this.contentRating = null
            }
        }
    }

    override suspend fun loadLinks(
        data: String,
        isCasting: Boolean,
        subtitleCallback: (SubtitleFile) -> Unit,
        callback: (ExtractorLink) -> Unit
    ): Boolean {
        val videoId = data
        val videosUrl = "$mainUrl/api/android/transcoddedFiles/id/$videoId"
        val subtitlesUrl = "$mainUrl/api/android/translationFiles/id/$videoId"

        app.get(videosUrl).parsedSafe<List<CinemanaVideo>>()?.forEach { video ->
            // تم التغيير: نقل المعاملات إلى داخل الكتلة
            newExtractorLink(
                source = this.name,
                name = video.resolution ?: this.name,
                url = video.videoUrl,
            ) {
                this.referer = "$mainUrl/"
                this.quality = video.resolution?.filter { it.isDigit() }?.toIntOrNull() ?: 0
            }.let { callback(it) }
        }

        app.get(subtitlesUrl).parsedSafe<CinemanaSubtitleHolder>()?.translations?.forEach { sub ->
            val lang = sub.name ?: "Unknown"
            subtitleCallback(
                SubtitleFile(
                    lang,
                    sub.file
                )
            )
        }

        return true
    }

    @Serializable
    data class CinemanaItem(
        val nb: String? = null,
        @SerialName("en_title") val enTitle: String? = null,
        val imgObjUrl: String? = null,
        val year: String? = null,
        @SerialName("en_content") val enContent: String? = null,
        val stars: String? = null,
        val videoType: Int? = null
    ) {
        fun toSearchResponse(): SearchResponse {
            val Cinemana = null
            val validUrl = nb ?: return {
                MovieSearchResponse(
                    "Error", "error",
                    this@CinemanaItem.toString().toString(), TvType.Movie, null, null
                )
            } as SearchResponse
            return if (this.videoType == 2) {
                TvSeriesSearchResponse(
                    name = enTitle ?: "No Title",
                    url = validUrl,
                    apiName = this@CinemanaItem.toString(),
                    type = TvType.TvSeries,
                    posterUrl = imgObjUrl,
                    year = this@CinemanaItem.year?.toIntOrNull()
                )
            } else {
                val movieSearchResponse = MovieSearchResponse(
                    name = enTitle ?: "No Title",
                    url = validUrl,
                    apiName = this@CinemanaItem.toString(),
                    type = TvType.Movie,
                    posterUrl = imgObjUrl,
                    year = this@CinemanaItem.year?.toIntOrNull()
                )
                movieSearchResponse
            }
        }
    }

    @Serializable
    data class CinemanaEpisode(
        val nb: String,
        val episodeNummer: String?,
        val season: String?
    )

    @Serializable
    data class CinemanaVideo(
        val videoUrl: String,
        val resolution: String?
    )

    @Serializable
    data class CinemanaSubtitleHolder(
        val translations: List<CinemanaSubtitleFile>?
    )

    @Serializable
    data class CinemanaSubtitleFile(
        val file: String,
        val name: String?
    )
}
